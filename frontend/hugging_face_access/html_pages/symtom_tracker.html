<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>HealthSync - Symptom Tracker</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#faba42",
            "background-light": "#f8f7f5",
            "background-dark": "#231c0f",
          },
          fontFamily: {
            "display": ["Manrope"]
          },
          borderRadius: {
            "DEFAULT": "0.5rem",
            "lg": "1rem",
            "xl": "1.5rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
<script src="js/include-components.js" defer></script>
<script src="js/auth.js"></script>
<style>
    body {
      font-family: 'Manrope', sans-serif;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-background-dark dark:text-background-light">
<div class="min-h-screen">
<!-- Include the navbar component -->
<div data-component="navbar"></div>
<script>
    // Check if user is authenticated
    document.addEventListener('DOMContentLoaded', function() {
        // Skip authentication check for demo purposes
        // Authentication will be handled by the actual auth system in production
    });
</script>
<main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
<div class="max-w-4xl mx-auto">
<div class="text-center mb-12">
<h2 class="text-4xl font-extrabold tracking-tight">Symptom Tracker</h2>
<p class="mt-4 text-lg text-background-dark/70 dark:text-background-light/70 max-w-2xl mx-auto">Log your symptoms to help your care team monitor your progress and adjust your treatment plan.</p>
</div>
<div class="space-y-12">
<section>
<h3 class="text-xl font-bold mb-4">1. How are you feeling today?</h3>
<div class="bg-background-light dark:bg-background-dark border border-primary/20 rounded-lg p-6">
<div class="relative">
<textarea class="w-full h-36 p-4 pr-16 rounded-lg bg-background-light dark:bg-background-dark border border-primary/30 focus:ring-2 focus:ring-primary focus:border-primary transition-all resize-none placeholder:text-background-dark/50 dark:placeholder:text-background-light/50" placeholder="Describe your symptoms in detail. For example: 'I have a sharp pain in my lower back that started this morning.'"></textarea>
<button class="absolute top-4 right-4 p-2 rounded-full hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
<span class="material-symbols-outlined">
                    mic
                  </span>
</button>
</div>
<div class="mt-4 flex flex-wrap gap-2">
<button class="px-4 py-2 text-sm font-medium rounded-full bg-primary/20 dark:bg-primary/30 hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors">Nausea</button>
<button class="px-4 py-2 text-sm font-medium rounded-full bg-primary/20 dark:bg-primary/30 hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors">Fatigue</button>
<button class="px-4 py-2 text-sm font-medium rounded-full bg-primary/20 dark:bg-primary/30 hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors">Pain</button>
<button class="px-4 py-2 text-sm font-medium rounded-full bg-primary/20 dark:bg-primary/30 hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors">Loss of Appetite</button>
<button class="px-4 py-2 text-sm font-medium rounded-full bg-primary/20 dark:bg-primary/30 hover:bg-primary/30 dark:hover:bg-primary/40 transition-colors">Insomnia</button>
</div>
</div>
</section>
<section>
<h3 class="text-xl font-bold mb-4">2. Upload an Image (Optional)</h3>
<div class="border-2 border-dashed border-primary/30 rounded-xl p-8 text-center bg-primary/5 dark:bg-primary/10">
<div class="flex flex-col items-center gap-4">
<span class="material-symbols-outlined text-5xl text-primary">
                  cloud_upload
                </span>
<p class="font-semibold">Drag and drop an image here, or browse</p>
<p class="text-sm text-background-dark/70 dark:text-background-light/70 max-w-md">
                  Upload an image of your symptoms, such as a rash or swelling, to provide additional context for your care team.
                </p>
<button class="mt-2 px-6 py-2 bg-primary/80 text-background-dark font-bold rounded-full hover:bg-primary transition-colors">
                  Browse Files
                </button>
</div>
</div>
</section>
<section>
<h3 class="text-xl font-bold mb-4">Analysis Results</h3>
<div class="space-y-4">
<div class="flex flex-col md:flex-row items-stretch gap-4 rounded-xl bg-background-light dark:bg-background-dark p-4 border border-primary/20 shadow-sm">
<div class="flex flex-col gap-1 flex-[2_2_0px] p-2">
<p class="text-lg font-bold">Symptom Severity</p>
<p class="text-background-dark/70 dark:text-background-light/70">Moderate</p>
</div>
<div class="w-full md:w-1/3 aspect-video bg-cover bg-center rounded-lg flex-1" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuB8NtHxzefQ96FRE8e6wJ2xKTxzPe7OQ5dvwRjPwheyihthmqNP-AQHowTsCcBlgoL2krYnngnbntoQeJadytk_QHRsyL5Bopf9sjcrTYyx8ieti81_mF3qbSFkycs5_5W8MzUWOQdn4XIaLDnDBngi2J2vYS7vLDM1mtiQLyNDZnuLoABNJ9f6evdPO_TXvG-F9PalJPpk7IlTPrwVoru3KDdy4MwiGLTsW7FwVqcfTdgpNpUSqsgfOFi7C6kldgfS2a4jC3WX7v5t");'></div>
</div>
<div class="flex flex-col md:flex-row items-stretch gap-4 rounded-xl bg-background-light dark:bg-background-dark p-4 border border-primary/20 shadow-sm">
<div class="flex flex-col gap-1 flex-[2_2_0px] p-2">
<p class="text-lg font-bold">Potential Causes</p>
<p class="text-background-dark/70 dark:text-background-light/70">Possible side effects of medication, further investigation recommended.</p>
</div>
<div class="w-full md:w-1/3 aspect-video bg-cover bg-center rounded-lg flex-1" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuA2ZhVZXFVMZq_KVhx6NJ1qnCgR5wMBhjx7iNW6QFOfiDV_YjJbDLkO2m1Xui32yFDVHN2e1ETjF_m6Uw-9quTnQDmO29bn6hCOHFN9Kaq4I6UKWnMiOs1Cj_BQftaeg25OJMbZj0MqW73ekm7QXXC7jBzbsGpntfjthbOP8tWFD0foNVXEd200A4_TG3hmYvZjURqu27Pd_3NoE466CXvl1ZWsEJqewiz5SuEb7Pz2614jsbZ4ff0UHKaCfFjRxeoNw5zDqvHODyFQ");'></div>
</div>
</div>
</section>
</div>
<div class="mt-12 flex justify-end">
<button id="submit-symptoms" class="px-8 py-3 bg-primary text-background-dark font-bold rounded-full text-lg hover:brightness-110 transition-all transform hover:scale-105">
            Submit Symptoms
          </button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const symptomsTextarea = document.querySelector('textarea');
    const symptomButtons = document.querySelectorAll('.px-4.py-2.text-sm.font-medium.rounded-full');
    const submitButton = document.getElementById('submit-symptoms');
    const analysisSection = document.querySelector('section:nth-child(3)');
    let selectedSymptoms = [];
    let imageData = null;
    
    // Handle symptom button clicks
    symptomButtons.forEach(button => {
      button.addEventListener('click', function() {
        const symptom = this.textContent.trim();
        if (this.classList.contains('bg-primary')) {
          // Deselect
          this.classList.remove('bg-primary');
          this.classList.add('bg-primary/20', 'dark:bg-primary/30');
          selectedSymptoms = selectedSymptoms.filter(s => s !== symptom);
        } else {
          // Select
          this.classList.remove('bg-primary/20', 'dark:bg-primary/30');
          this.classList.add('bg-primary');
          selectedSymptoms.push(symptom);
        }
      });
    });
    
    // Handle file upload
    const browseButton = document.querySelector('.mt-2.px-6.py-2');
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    browseButton.addEventListener('click', function() {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
          imageData = event.target.result;
          // Update UI to show selected image
          const uploadSection = document.querySelector('.border-2.border-dashed');
          uploadSection.style.backgroundImage = `url(${imageData})`;
          uploadSection.style.backgroundSize = 'cover';
          uploadSection.style.backgroundPosition = 'center';
          uploadSection.innerHTML = '<div class="p-4 bg-background-dark/50 rounded-lg"><p class="text-background-light font-bold">Image selected</p><button class="mt-2 px-4 py-1 bg-red-500 text-white rounded-full text-sm">Remove</button></div>';
          
          // Add remove button functionality
          uploadSection.querySelector('button').addEventListener('click', function(e) {
            e.stopPropagation();
            imageData = null;
            uploadSection.style.backgroundImage = '';
            uploadSection.style.backgroundColor = '';
            uploadSection.innerHTML = originalUploadHTML;
            // Reattach event listeners
            document.querySelector('.mt-2.px-6.py-2').addEventListener('click', function() {
              fileInput.click();
            });
          });
        };
        
        reader.readAsDataURL(file);
      }
    });
    
    // Store original upload section HTML
    const originalUploadHTML = document.querySelector('.border-2.border-dashed').innerHTML;
    
    // Handle form submission
    submitButton.addEventListener('click', async function() {
      const symptomsText = symptomsTextarea.value.trim();
      
      if (!symptomsText && selectedSymptoms.length === 0) {
        alert('Please describe your symptoms or select symptom categories');
        return;
      }
      
      // Show loading state
      this.disabled = true;
      this.innerHTML = '<span class="animate-spin inline-block mr-2">⟳</span> Analyzing...';
      
      try {
        // Prepare symptoms data
        const symptoms = symptomsText + (selectedSymptoms.length > 0 ? '\n\nSelected categories: ' + selectedSymptoms.join(', ') : '');
        
        // Save symptom data to local storage for health record
        const currentDate = new Date();
        const formattedDate = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Get existing symptom records or initialize empty array
        const existingRecords = JSON.parse(localStorage.getItem('healthsync_symptoms') || '[]');
        
        // Create new symptom record
        const newRecord = {
          date: formattedDate,
          symptoms: selectedSymptoms.length > 0 ? selectedSymptoms.join(', ') : 'General symptoms',
          description: symptomsText,
          severity: 'moderate', // Default severity, could be extracted from analysis later
          timestamp: Date.now(),
          image: imageData
        };
        
        // Add new symptom record
        existingRecords.push(newRecord);
        
        // Save back to local storage
        localStorage.setItem('healthsync_symptoms', JSON.stringify(existingRecords));
        
        // Immediately update health_record.html if it's open in another tab
        // Create and dispatch a custom event that health_record.html can listen for
        const healthRecordUpdateEvent = new CustomEvent('healthsync_record_updated', {
          detail: { newRecord }
        });
        window.dispatchEvent(healthRecordUpdateEvent);
        
        // Also store the latest record separately for immediate access
        localStorage.setItem('healthsync_latest_symptom', JSON.stringify(newRecord));
        
        // Call the appropriate API based on whether an image was uploaded
        let response;
        let analysisData;
        
        if (imageData) {
          response = await fetch('/analyze-image', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              image: imageData,
              description: symptoms
            })
          });
          
          analysisData = await response.json();
          
          // Also send the symptoms to the meal recommendation endpoint
          if (analysisData.analysis) {
            // Extract severity from analysis if available
            const severityMatch = analysisData.analysis.match(/Severity assessment[:\s]*(mild|moderate|severe)/i);
            const severity = severityMatch ? severityMatch[1] : 'moderate';
            
            // Send to meal recommendation endpoint
            fetch('/recommend-meals', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                symptoms: symptoms,
                severity: severity,
                preferences: 'Indian cuisine',
                restrictions: ''
              })
            }).catch(err => console.error('Error sending meal recommendations:', err));
          }
        } else {
          response = await fetch('/analyze-symptoms', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              symptoms: symptoms,
              userInfo: 'Age: 35, Gender: Female' // This would come from user profile in a real app
            })
          });
          
          analysisData = await response.json();
          
          // Also send the symptoms to the meal recommendation endpoint
          if (analysisData.analysis) {
            // Extract severity from analysis if available
            const severityMatch = analysisData.analysis.match(/Severity assessment[:\s]*(mild|moderate|severe)/i);
            const severity = severityMatch ? severityMatch[1] : 'moderate';
            
            // Send to meal recommendation endpoint
            fetch('/recommend-meals', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                symptoms: symptoms,
                severity: severity,
                preferences: 'Indian cuisine',
                restrictions: ''
              })
            }).catch(err => console.error('Error sending meal recommendations:', err));
          }
        }
        
        if (analysisData.analysis) {
          // Update the analysis section with the response
          analysisSection.innerHTML = `
            <h3 class="text-xl font-bold mb-4">Analysis Results</h3>
            <div class="bg-background-light dark:bg-background-dark border border-primary/20 rounded-lg p-6">
              <div class="prose dark:prose-invert max-w-none">
                ${analysisData.analysis}
              </div>
            </div>
            <div class="mt-4 text-center">
              <p class="text-sm text-background-dark/70 dark:text-background-light/70">Your meal recommendations have been updated based on your symptoms.</p>
              <a href="meal_recommendation.html" class="mt-2 inline-block px-6 py-2 bg-primary text-background-dark font-bold rounded-full hover:brightness-110 transition-all">View Meal Recommendations</a>
            </div>
          `;
          
          // Scroll to analysis section
          analysisSection.scrollIntoView({ behavior: 'smooth' });
        } else if (analysisData.error) {
          alert(`Error: ${analysisData.error}`);
        }
      } catch (error) {
        console.error('Error analyzing symptoms:', error);
        alert('Sorry, there was an error analyzing your symptoms. Please try again later.');
      } finally {
        // Reset button state
        this.disabled = false;
        this.innerHTML = 'Submit Symptoms';
      }
    });
  });
</script>
</div>
</main>
</div>

</body></html>

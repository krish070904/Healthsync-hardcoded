<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthSync - Register</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .register-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        .register-card h2 {
            color: #6a11cb;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .password-requirements {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .requirement-met {
            color: #198754;
        }
        .requirement-unmet {
            color: #dc3545;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            padding: 0.8rem;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .login-link {
            text-align: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="register-card">
        <h2>Create Account</h2>
        <form id="registerForm">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required minlength="3" maxlength="30" pattern="[a-zA-Z0-9_-]+">
                <div class="invalid-feedback" id="usernameError"></div>
                <small class="form-text text-muted">Username must be 3-30 characters long and can only contain letters, numbers, underscores, and hyphens.</small>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
                <div class="invalid-feedback" id="emailError"></div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required minlength="8">
                <div class="invalid-feedback" id="passwordError"></div>
                <div class="password-requirements mt-2">
                    <p class="mb-1">Password must contain:</p>
                    <div id="length-req" class="requirement-unmet">✓ At least 8 characters</div>
                    <div id="uppercase-req" class="requirement-unmet">✓ At least one uppercase letter</div>
                    <div id="lowercase-req" class="requirement-unmet">✓ At least one lowercase letter</div>
                    <div id="number-req" class="requirement-unmet">✓ At least one number</div>
                    <div id="special-req" class="requirement-unmet">✓ At least one special character</div>
                </div>
            </div>
            <div id="registrationError" class="alert alert-danger d-none" role="alert"></div>
            <div class="mb-3">
                <label for="full_name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="full_name">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label for="age" class="form-label">Age</label>
                    <input type="number" class="form-control" id="age" min="1" max="120">
                </div>
                <div class="col">
                    <label for="gender" class="form-label">Gender</label>
                    <select class="form-control" id="gender">
                        <option value="">Select gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label for="height_cm" class="form-label">Height (cm)</label>
                    <input type="number" class="form-control" id="height_cm" min="1" max="300">
                </div>
                <div class="col">
                    <label for="weight_kg" class="form-label">Weight (kg)</label>
                    <input type="number" class="form-control" id="weight_kg" min="1" max="500">
                </div>
            </div>
            <div class="mb-3">
                <label for="medical_conditions" class="form-label">Medical Conditions</label>
                <textarea class="form-control" id="medical_conditions" rows="2" placeholder="List any medical conditions"></textarea>
            </div>
            <div class="mb-3">
                <label for="allergies" class="form-label">Allergies</label>
                <textarea class="form-control" id="allergies" rows="2" placeholder="List any allergies"></textarea>
            </div>
            <div class="mb-3">
                <label for="medications" class="form-label">Current Medications</label>
                <textarea class="form-control" id="medications" rows="2" placeholder="List any medications"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">Register</button>
            <div class="login-link">
                <p class="mb-0">Already have an account? <a href="/login">Login here</a></p>
            </div>
        </form>
    </div>

    <script>
        const password = document.getElementById('password');
        const username = document.getElementById('username');
        const email = document.getElementById('email');

        function validatePassword(value) {
            const requirements = {
                length: value.length >= 8,
                uppercase: /[A-Z]/.test(value),
                lowercase: /[a-z]/.test(value),
                number: /[0-9]/.test(value),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(value)
            };

            document.getElementById('length-req').className = requirements.length ? 'requirement-met' : 'requirement-unmet';
            document.getElementById('uppercase-req').className = requirements.uppercase ? 'requirement-met' : 'requirement-unmet';
            document.getElementById('lowercase-req').className = requirements.lowercase ? 'requirement-met' : 'requirement-unmet';
            document.getElementById('number-req').className = requirements.number ? 'requirement-met' : 'requirement-unmet';
            document.getElementById('special-req').className = requirements.special ? 'requirement-met' : 'requirement-unmet';

            return Object.values(requirements).every(req => req);
        }

        password.addEventListener('input', (e) => {
            validatePassword(e.target.value);
        });

        username.addEventListener('input', (e) => {
            const isValid = e.target.value.length >= 3 && e.target.value.length <= 30 && /^[a-zA-Z0-9_-]+$/.test(e.target.value);
            username.classList.toggle('is-invalid', !isValid);
            if (!isValid) {
                document.getElementById('usernameError').textContent = 'Username must be 3-30 characters long and can only contain letters, numbers, underscores, and hyphens.';
            }
        });

        email.addEventListener('input', (e) => {
            const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.target.value);
            email.classList.toggle('is-invalid', !isValid);
            if (!isValid) {
                document.getElementById('emailError').textContent = 'Please enter a valid email address.';
            }
        });

        const registerForm = document.getElementById('registerForm');
        const submitButton = registerForm.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate password requirements
            if (!validatePassword(password.value)) {
                const registrationError = document.getElementById('registrationError');
                registrationError.textContent = 'Please meet all password requirements';
                registrationError.classList.remove('d-none');
                return;
            }

            // Reset previous error states
            document.getElementById('registrationError').classList.add('d-none');
            document.getElementById('username').classList.remove('is-invalid');
            document.getElementById('email').classList.remove('is-invalid');
            document.getElementById('password').classList.remove('is-invalid');

            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating account...';

            try {
                const formData = {
                    username: username.value,
                    email: email.value,
                    password: password.value,
                    full_name: document.getElementById('full_name').value || undefined,
                    age: document.getElementById('age').value ? parseInt(document.getElementById('age').value) : undefined,
                    gender: document.getElementById('gender').value || undefined,
                    height_cm: document.getElementById('height_cm').value ? parseFloat(document.getElementById('height_cm').value) : undefined,
                    weight_kg: document.getElementById('weight_kg').value ? parseFloat(document.getElementById('weight_kg').value) : undefined,
                    medical_conditions: document.getElementById('medical_conditions').value || undefined,
                    allergies: document.getElementById('allergies').value || undefined,
                    medications: document.getElementById('medications').value || undefined
                };

                // Remove undefined values
                Object.keys(formData).forEach(key => formData[key] === undefined && delete formData[key]);

                const response = await fetch('/users/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (response.ok) {
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success';
                    successAlert.textContent = 'Registration successful! Redirecting to login...';
                    registerForm.prepend(successAlert);

                    // Automatically login after successful registration
                    try {
                        const loginResponse = await fetch('/token', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `username=${encodeURIComponent(username.value)}&password=${encodeURIComponent(password.value)}`
                        });

                        if (loginResponse.ok) {
                            const loginData = await loginResponse.json();
                            localStorage.setItem('token', loginData.access_token);
                            window.location.href = '/';
                        } else {
                            setTimeout(() => window.location.href = '/login', 2000);
                        }
                    } catch (error) {
                        setTimeout(() => window.location.href = '/login', 2000);
                    }
                } else {
                    const registrationError = document.getElementById('registrationError');
                    registrationError.textContent = data.detail || 'Registration failed. Please try again.';
                    registrationError.classList.remove('d-none');

                    // Show field-specific errors
                    if (data.detail.includes('username')) {
                        username.classList.add('is-invalid');
                        document.getElementById('usernameError').textContent = data.detail;
                    }
                    if (data.detail.includes('email')) {
                        email.classList.add('is-invalid');
                        document.getElementById('emailError').textContent = data.detail;
                    }
                    if (data.detail.includes('password')) {
                        password.classList.add('is-invalid');
                        document.getElementById('passwordError').textContent = data.detail;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                const registrationError = document.getElementById('registrationError');
                registrationError.textContent = 'An error occurred during registration. Please try again.';
                registrationError.classList.remove('d-none');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });
    </script>
</body>
</html>